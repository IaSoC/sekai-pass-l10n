<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SEKAI Pass PKCE é›†æˆç¤ºä¾‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Noto Sans SC', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }

    .badge {
      display: inline-block;
      background: #10b981;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .login-btn:hover {
      transform: translateY(-2px);
    }

    .user-info {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .user-info h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .user-info p {
      color: #666;
      margin-bottom: 8px;
    }

    .user-info strong {
      color: #333;
    }

    .logout-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .logout-btn:hover {
      background: #c82333;
    }

    .hidden {
      display: none;
    }

    .loading {
      text-align: center;
      color: #666;
      padding: 20px;
    }

    .error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
    }

    .info-box {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-size: 14px;
    }

    .info-box h3 {
      color: #0066cc;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .info-box code {
      background: #fff;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      SEKAI Pass PKCE é›†æˆ
      <span class="badge">ğŸ”’ å®‰å…¨</span>
    </h1>
    <p class="subtitle">ä½¿ç”¨ PKCE æµç¨‹ï¼Œæ— éœ€åç«¯ï¼Œå®Œå…¨å®‰å…¨</p>

    <!-- æœªç™»å½•çŠ¶æ€ -->
    <div id="login-section">
      <button class="login-btn" onclick="loginWithPKCE()">
        ä½¿ç”¨ SEKAI Pass ç™»å½• (PKCE)
      </button>

      <div class="info-box">
        <h3>âœ¨ PKCE ä¼˜åŠ¿</h3>
        <p>â€¢ ä¸éœ€è¦ <code>client_secret</code></p>
        <p>â€¢ é˜²æ­¢æˆæƒç æ‹¦æˆªæ”»å‡»</p>
        <p>â€¢ é€‚åˆçº¯å‰ç«¯åº”ç”¨</p>
        <p>â€¢ OAuth 2.1 å®˜æ–¹æ¨è</p>
      </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loading-section" class="hidden">
      <div class="loading">æ­£åœ¨éªŒè¯èº«ä»½...</div>
    </div>

    <!-- å·²ç™»å½•çŠ¶æ€ -->
    <div id="user-section" class="hidden">
      <div class="user-info">
        <h2>âœ… ç™»å½•æˆåŠŸ</h2>
        <p><strong>ç”¨æˆ·å:</strong> <span id="username"></span></p>
        <p><strong>é‚®ç®±:</strong> <span id="email"></span></p>
        <p><strong>æ˜µç§°:</strong> <span id="display-name"></span></p>
        <p><strong>ç”¨æˆ· ID:</strong> <span id="user-id"></span></p>
        <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <!-- é”™è¯¯ä¿¡æ¯ -->
    <div id="error-section" class="hidden">
      <div class="error" id="error-message"></div>
    </div>
  </div>

  <script>
    // é…ç½®
    const SEKAI_PASS_URL = 'https://id.nightcord.de5.net';
    const CLIENT_ID = 'pkce-client'; // PKCE å®¢æˆ·ç«¯ ID
    const REDIRECT_URI = window.location.origin + window.location.pathname;

    // Base64 URL ç¼–ç ï¼ˆæ— å¡«å……ï¼‰
    function base64URLEncode(buffer) {
      const bytes = Array.from(new Uint8Array(buffer));
      const base64 = btoa(String.fromCharCode(...bytes));
      return base64
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=/g, '');
    }

    // ç”Ÿæˆ PKCE å‚æ•°
    async function generatePKCE() {
      // 1. ç”Ÿæˆéšæœº code_verifier (43-128 å­—ç¬¦)
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      const codeVerifier = base64URLEncode(array);

      // 2. è®¡ç®— code_challenge = SHA256(code_verifier)
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const hash = await crypto.subtle.digest('SHA-256', data);
      const codeChallenge = base64URLEncode(hash);

      return {
        codeVerifier,
        codeChallenge,
        codeChallengeMethod: 'S256'
      };
    }

    // ä½¿ç”¨ PKCE ç™»å½•
    async function loginWithPKCE() {
      try {
        // ç”Ÿæˆ PKCE å‚æ•°
        const pkce = await generatePKCE();

        // ä¿å­˜ code_verifier åˆ° sessionStorage
        sessionStorage.setItem('pkce_code_verifier', pkce.codeVerifier);

        // æ„å»ºæˆæƒ URL
        const authUrl = `${SEKAI_PASS_URL}/oauth/authorize?` +
          `client_id=${CLIENT_ID}&` +
          `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
          `response_type=code&` +
          `code_challenge=${pkce.codeChallenge}&` +
          `code_challenge_method=${pkce.codeChallengeMethod}`;

        // é‡å®šå‘åˆ°æˆæƒé¡µé¢
        window.location.href = authUrl;
      } catch (error) {
        console.error('PKCE generation error:', error);
        showError('ç”Ÿæˆ PKCE å‚æ•°å¤±è´¥');
      }
    }

    // å¤„ç†å›è°ƒ
    async function handleCallback(code) {
      showLoading();

      try {
        // è·å–ä¿å­˜çš„ code_verifier
        const codeVerifier = sessionStorage.getItem('pkce_code_verifier');
        if (!codeVerifier) {
          throw new Error('code_verifier not found');
        }

        // æ¸…é™¤ code_verifier
        sessionStorage.removeItem('pkce_code_verifier');

        // ç”¨æˆæƒç å’Œ code_verifier äº¤æ¢ä»¤ç‰Œ
        const tokenResponse = await fetch(`${SEKAI_PASS_URL}/oauth/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({
            grant_type: 'authorization_code',
            code: code,
            client_id: CLIENT_ID,
            code_verifier: codeVerifier,
            redirect_uri: REDIRECT_URI
          })
        });

        if (!tokenResponse.ok) {
          const error = await tokenResponse.json();
          throw new Error(error.error_description || error.error || 'Token exchange failed');
        }

        const { access_token } = await tokenResponse.json();

        // è·å–ç”¨æˆ·ä¿¡æ¯
        const userResponse = await fetch(`${SEKAI_PASS_URL}/oauth/userinfo`, {
          headers: {
            'Authorization': `Bearer ${access_token}`
          }
        });

        if (!userResponse.ok) {
          throw new Error('Failed to fetch user info');
        }

        const user = await userResponse.json();

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('sekai_user', JSON.stringify(user));
        localStorage.setItem('sekai_token', access_token);

        // æ¸…ç† URL
        window.history.replaceState({}, document.title, window.location.pathname);

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        showUser(user);

      } catch (error) {
        console.error('Authentication error:', error);
        showError('ç™»å½•å¤±è´¥: ' + error.message);
      }
    }

    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    function showUser(user) {
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('loading-section').classList.add('hidden');
      document.getElementById('error-section').classList.add('hidden');
      document.getElementById('user-section').classList.remove('hidden');

      document.getElementById('username').textContent = user.username;
      document.getElementById('email').textContent = user.email;
      document.getElementById('display-name').textContent = user.display_name || 'æœªè®¾ç½®';
      document.getElementById('user-id').textContent = user.id;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading() {
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('user-section').classList.add('hidden');
      document.getElementById('error-section').classList.add('hidden');
      document.getElementById('loading-section').classList.remove('hidden');
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
      document.getElementById('login-section').classList.remove('hidden');
      document.getElementById('loading-section').classList.add('hidden');
      document.getElementById('user-section').classList.add('hidden');
      document.getElementById('error-section').classList.remove('hidden');
      document.getElementById('error-message').textContent = message;
    }

    // ç™»å‡º
    function logout() {
      localStorage.removeItem('sekai_user');
      localStorage.removeItem('sekai_token');
      location.reload();
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const error = urlParams.get('error');

      if (error) {
        showError('æˆæƒå¤±è´¥: ' + error);
        window.history.replaceState({}, document.title, window.location.pathname);
      } else if (code) {
        handleCallback(code);
      } else {
        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯
        const savedUser = localStorage.getItem('sekai_user');
        if (savedUser) {
          showUser(JSON.parse(savedUser));
        }
      }
    });

    // å¯¼å‡ºåˆ°å…¨å±€
    window.SEKAI = {
      loginWithPKCE,
      logout,
      getUser: () => {
        const savedUser = localStorage.getItem('sekai_user');
        return savedUser ? JSON.parse(savedUser) : null;
      }
    };
  </script>
</body>
</html>
